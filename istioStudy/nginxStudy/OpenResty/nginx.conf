
pid        logs/nginx.pid;

events {
    worker_connections  1024;
}


http {

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    log_format  main  '$remote_addr $remote_user [$time_local] "$request" $http_host '
        '$status $upstream_status $body_bytes_sent "$http_referer" '
        '"$http_user_agent” $ssl_protocol $ssl_cipher $upstream_addr '
        '$request_time $upstream_response_time';

    access_log  logs/access.log  main;

	#upstream backend {

	#	server httpbin.k8s-master:32207;
	#	}

	#共享全局变量，在所有worker间共享
    lua_shared_dict shared_data 1m;

    #lua模块路径，其中”;;”表示默认搜索路径，默认到/usr/servers/nginx下找
    lua_package_path "/home/xiaodong/tools/server1-nginx/nginx/conf/lualib/?.lua;;";  #lua 模块
    lua_package_cpath "/home/xiaodong/tools/server1-nginx/nginx/conf/lualib/?.so;;";  #c模块

	include lua.conf; # enable lua code part in the lua.conf

    server {

        listen       8090;
        server_name  k8s_master;

        root html/;



	    location /test {
	        #proxy_ssl_name  httpbin.microservice.rocks;
	        #proxy_ssl_verify_depth  4;
	        #proxy_ssl_certificate /home/xiaodong/tools/server1-nginx/nginx/conf/httpbin.microservice.rocks/4_client/certs/httpbin.microservice.rocks.cert.pem;
            #proxy_ssl_certificate_key /home/xiaodong/tools/server1-nginx/nginx/conf/httpbin.microservice.rocks/4_client/private/httpbin.microservice.rocks.key.pem;
            #proxy_ssl_trusted_certificate /home/xiaodong/tools/server1-nginx/nginx/conf/httpbin.microservice.rocks/2_intermediate/certs/ca-chain.cert.pem;
            #proxy_ssl_server_name   off;
            proxy_http_version 1.1;
		    proxy_set_header Host "httpbin.microservice.rocks";
		    proxy_set_header X-Real-IP $remote_addr;
		    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		    proxy_pass   https://k8s-master:8092;
        }

        # using istio-ingressgateway to expose the service defined by virtualservice & gateway for routing configurations

	    location /httpbin/ {
            proxy_pass   http://k8s-master:31380/;
            proxy_http_version 1.1;
		    proxy_set_header Host "httpbin.microservice.rocks";
		    proxy_set_header X-Real-IP $remote_addr;
		    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

	    location /flaskapp/ {
            proxy_pass   http://k8s-master:31380/;
            proxy_http_version 1.1;
		    proxy_set_header Host "flaskapp.microservice.rocks";
		    proxy_set_header X-Real-IP $remote_addr;
		    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

	    location /httpbin-sec/ {
	        proxy_ssl_name  httpbin.microservice.rocks;
	        proxy_ssl_verify_depth  4;
	        proxy_ssl_certificate /home/xiaodong/tools/server1-nginx/nginx/conf/httpbin.microservice.rocks/httpbin.microservice.rocks.nginx.crt;
            proxy_ssl_certificate_key /home/xiaodong/tools/server1-nginx/nginx/conf/httpbin.microservice.rocks/httpbin.microservice.rocks.nginx.key;
            #proxy_ssl_trusted_certificate /home/xiaodong/tools/server1-nginx/nginx/conf/ca.crt;
            proxy_ssl_server_name   on;
            proxy_http_version 1.1;
		    proxy_set_header Host "httpbin.microservice.rocks";
		    proxy_set_header X-Real-IP $remote_addr;
		    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		    proxy_pass   https://k8s-master:31390/;
        }

	    location /flaskapp-sec/ {
	        proxy_ssl_name  flaskapp.microservice.rocks;
	        proxy_ssl_verify_depth  4;
	        proxy_ssl_certificate /home/xiaodong/tools/server1-nginx/nginx/conf/flaskapp.microservice.rocks/flaskapp.microservice.rocks.nginx.crt;
            proxy_ssl_certificate_key /home/xiaodong/tools/server1-nginx/nginx/conf/flaskapp.microservice.rocks/flaskapp.microservice.rocks.nginx.key;
            #proxy_ssl_trusted_certificate /home/xiaodong/tools/server1-nginx/nginx/conf/ca.crt;
            proxy_ssl_server_name on;
            proxy_http_version 1.1;
		    proxy_set_header Host "flaskapp.microservice.rocks";
		    proxy_set_header X-Real-IP $remote_addr;
		    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		    proxy_pass   https://k8s-master:31390/;
        }

	    location /flaskapp-sec-xyz/ {
	        proxy_ssl_name  flaskapp.microservice.xyz;
	        proxy_ssl_verify_depth  4;
	        proxy_ssl_certificate /home/xiaodong/tools/server1-nginx/nginx/conf/flaskapp.microservice.xyz/flaskapp.microservice.xyz.nginx.crt;
            proxy_ssl_certificate_key /home/xiaodong/tools/server1-nginx/nginx/conf/flaskapp.microservice.xyz/flaskapp.microservice.xyz.nginx.key;
            #proxy_ssl_trusted_certificate /home/xiaodong/tools/server1-nginx/nginx/conf/ca.crt;
            proxy_ssl_server_name on;
            proxy_http_version 1.1;
		    proxy_set_header Host "flaskapp.microservice.xyz";
		    proxy_set_header X-Real-IP $remote_addr;
		    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		    proxy_pass   https://k8s-master:31390/;
        }

        location ^~ /grafana/ {

            proxy_pass   http://grafana.k8s-master:32207/;
            proxy_cache  off;
            proxy_http_version 1.1;
		    proxy_set_header Host "grafana.k8s-master";
		    proxy_set_header X-Real-IP $remote_addr;
		    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        }



	}



}
